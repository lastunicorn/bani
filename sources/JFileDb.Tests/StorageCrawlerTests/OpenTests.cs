using DustInTheWind.JFileDb.New;
using DustInTheWind.JFileDb.Tests.Helpers;

namespace DustInTheWind.JFileDb.Tests.StorageCrawlerTests;

public class OpenTests : IDisposable
{
    private readonly TemporaryDatabase temporaryDatabase;

    public OpenTests()
    {
        temporaryDatabase = new TemporaryDatabase();
    }

    public void Dispose()
    {
        temporaryDatabase?.Dispose();
    }

    [Fact]
    public void Open_EmptyDirectory_ReturnsEmptyCollection()
    {
        // Arrange
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Empty(result);
    }

    [Fact]
    public void Open_WithMainDocument_ReturnsDocumentMetadata()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = []
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithChildDocument_ReturnsDocumentMetadata()
    {
        // Arrange
        temporaryDatabase.CreateChildDocument("emission");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expected = new()
        {
            TypeId = "emission",
            Directories = [],
            Children = []
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithMainDocumentAndChildrenInSubdirectory_ReturnsHierarchicalStructure()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = []
                }
            ]
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithInvalidFileName_IgnoresFile()
    {
        // Arrange
        temporaryDatabase.CreateDocumentFile("invalid-file.json");
        temporaryDatabase.CreateDocumentFile("another.json");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Empty(result);
    }

    [Fact]
    public void Open_WithNonJsonFiles_IgnoresFiles()
    {
        // Arrange
        temporaryDatabase.CreateNonJsonFile("m-issuer.txt");
        temporaryDatabase.CreateNonJsonFile("m-issuer.xml");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Empty(result);
    }

    [Fact]
    public void Open_WithComplexHierarchy_ReturnsCorrectStructure()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");
        temporaryDatabase.CreateMainDocument("coin", "romania/al patrulea leu/series1");
        temporaryDatabase.CreateMainDocument("banknote", "romania/al patrulea leu/series2");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = [
                        new DocumentMetadata
                        {
                            TypeId = "coin",
                            Directories = ["romania", "al patrulea leu", "series1"],
                            Children = []
                        },
                        new DocumentMetadata
                        {
                            TypeId = "banknote",
                            Directories = ["romania", "al patrulea leu", "series2"],
                            Children = []
                        }
                    ]
                }
            ]
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithLocalChild_ReturnsCorrectStructure()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");
        temporaryDatabase.CreateMainDocument("coin", "romania/al patrulea leu/5 lei");
        temporaryDatabase.CreateChildDocument("banknote", "romania/al patrulea leu");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = [
                        new DocumentMetadata
                        {
                            TypeId = "banknote",
                            Directories = ["romania", "al patrulea leu"],
                            Children = []
                        },
                        new DocumentMetadata
                        {
                            TypeId = "coin",
                            Directories = ["romania", "al patrulea leu", "5 lei"],
                            Children = []
                        }
                    ]
                }
            ]
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_DemonstrationOfCustomAssert_UsesDeepComparison()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Expected structure
        DocumentMetadata expectedIssuer = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = []
                }
            ]
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert using custom deep comparison
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expectedIssuer, result[0]);
    }
}