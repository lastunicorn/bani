using DustInTheWind.JFileDb.New;
using DustInTheWind.JFileDb.Tests.Helpers;

namespace DustInTheWind.JFileDb.Tests.StorageCrawlerTests;

public class OpenTests : IDisposable
{
    private readonly TemporaryDatabase temporaryDatabase;

    public OpenTests()
    {
        temporaryDatabase = new TemporaryDatabase();
    }

    public void Dispose()
    {
        temporaryDatabase?.Dispose();
    }

    [Fact]
    public void Open_EmptyDirectory_ReturnsEmptyCollection()
    {
        // Arrange
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Empty(result);
    }

    [Fact]
    public void Open_WithMainDocument_ReturnsDocumentMetadata()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [],
            Parent = null
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithChildDocument_ReturnsDocumentMetadata()
    {
        // Arrange
        temporaryDatabase.CreateChildDocument("emission");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expected = new()
        {
            TypeId = "emission",
            Directories = [],
            Children = [],
            Parent = null
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithMainDocumentAndChildrenInSubdirectory_ReturnsHierarchicalStructure()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expectedParent = new()
        {
            TypeId = "issuer",
            Directories = [],
            Parent = null
        };

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = [],
                    Parent = expectedParent
                }
            ],
            Parent = null
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithInvalidFileName_IgnoresFile()
    {
        // Arrange
        temporaryDatabase.CreateDocumentFile("invalid-file.json");
        temporaryDatabase.CreateDocumentFile("another.json");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Empty(result);
    }

    [Fact]
    public void Open_WithNonJsonFiles_IgnoresFiles()
    {
        // Arrange
        temporaryDatabase.CreateNonJsonFile("m-issuer.txt");
        temporaryDatabase.CreateNonJsonFile("m-issuer.xml");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Empty(result);
    }

    [Fact]
    public void Open_WithComplexHierarchy_ReturnsCorrectStructure()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");
        temporaryDatabase.CreateMainDocument("coin", "romania/al patrulea leu/series1");
        temporaryDatabase.CreateMainDocument("banknote", "romania/al patrulea leu/series2");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expectedIssuer = new()
        {
            TypeId = "issuer",
            Directories = [],
            Parent = null
        };

        DocumentMetadata expectedEmission = new()
        {
            TypeId = "emission",
            Directories = ["romania"],
            Parent = expectedIssuer
        };

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = [
                        new DocumentMetadata
                        {
                            TypeId = "coin",
                            Directories = ["romania", "al patrulea leu", "series1"],
                            Children = [],
                            Parent = expectedEmission
                        },
                        new DocumentMetadata
                        {
                            TypeId = "banknote",
                            Directories = ["romania", "al patrulea leu", "series2"],
                            Children = [],
                            Parent = expectedEmission
                        }
                    ],
                    Parent = expectedIssuer
                }
            ],
            Parent = null
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_WithLocalChild_ReturnsCorrectStructure()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");
        temporaryDatabase.CreateMainDocument("coin", "romania/al patrulea leu/5 lei");
        temporaryDatabase.CreateChildDocument("banknote", "romania/al patrulea leu");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        DocumentMetadata expectedIssuer = new()
        {
            TypeId = "issuer",
            Directories = [],
            Parent = null
        };

        DocumentMetadata expectedEmission = new()
        {
            TypeId = "emission",
            Directories = ["romania"],
            Parent = expectedIssuer
        };

        DocumentMetadata expected = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = [
                        new DocumentMetadata
                        {
                            TypeId = "banknote",
                            Directories = ["romania", "al patrulea leu"],
                            Children = [],
                            Parent = expectedEmission
                        },
                        new DocumentMetadata
                        {
                            TypeId = "coin",
                            Directories = ["romania", "al patrulea leu", "5 lei"],
                            Children = [],
                            Parent = expectedEmission
                        }
                    ],
                    Parent = expectedIssuer
                }
            ],
            Parent = null
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expected, result[0]);
    }

    [Fact]
    public void Open_DemonstrationOfCustomAssert_UsesDeepComparison()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");
        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Expected structure
        DocumentMetadata expectedIssuer = new()
        {
            TypeId = "issuer",
            Directories = [],
            Parent = null
        };

        DocumentMetadata expectedWithChildren = new()
        {
            TypeId = "issuer",
            Directories = [],
            Children = [
                new DocumentMetadata
                {
                    TypeId = "emission",
                    Directories = ["romania"],
                    Children = [],
                    Parent = expectedIssuer
                }
            ],
            Parent = null
        };

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert using custom deep comparison
        Assert.Single(result);
        DocumentMetadataAssert.DeepEqual(expectedWithChildren, result[0]);
    }

    [Fact]
    public void Open_WithHierarchy_VerifiesParentChildRelationships()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateMainDocument("emission", "romania");
        temporaryDatabase.CreateChildDocument("banknote", "romania");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadata issuer = result[0];
        Assert.Null(issuer.Parent);
        Assert.Single(issuer.Children);

        DocumentMetadata emission = issuer.Children[0];
        Assert.Same(issuer, emission.Parent);
        Assert.Single(emission.Children);

        DocumentMetadata banknote = emission.Children[0];
        Assert.Same(emission, banknote.Parent);
        Assert.Empty(banknote.Children);
    }

    [Fact]
    public void Open_WithMainDocumentAndLocalChildDocument_VerifiesParentChildRelationships()
    {
        // Arrange
        temporaryDatabase.CreateMainDocument("issuer");
        temporaryDatabase.CreateChildDocument("emission");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadata issuer = result[0];
        Assert.Null(issuer.Parent);
        Assert.Single(issuer.Children);

        DocumentMetadata emission = issuer.Children[0];
        Assert.Same(issuer, emission.Parent);
        Assert.Empty(emission.Children);
    }

    [Fact]
    public void Open_WithStandaloneChildDocument_HasNoParent()
    {
        // Arrange
        temporaryDatabase.CreateChildDocument("emission");

        StorageCrawler crawler = new(temporaryDatabase.RootPath);

        // Act
        crawler.Open();
        List<DocumentMetadata> result = crawler.Items;

        // Assert
        Assert.Single(result);
        DocumentMetadata emission = result[0];
        Assert.Null(emission.Parent);
        Assert.Empty(emission.Children);
    }
}